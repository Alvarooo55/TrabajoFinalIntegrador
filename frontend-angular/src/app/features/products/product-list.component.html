<section class="hero-block mb-4">
  <div class="d-flex flex-wrap justify-content-between align-items-center gap-3">
    <div>
      <h1 class="h3 mb-1">Catálogo SportStock</h1>
      <p class="hero-subtitle">Gestión inteligente de productos deportivos con control de stock y estado en tiempo real.</p>
    </div>
    <a class="btn btn-light fw-semibold" routerLink="/productos/nuevo">+ Nuevo producto</a>
  </div>

  <div class="d-flex flex-wrap gap-2 mt-3">
    <span class="metric-chip">Registros: {{ total }}</span>
    <span class="metric-chip">Páginas: {{ totalPages }}</span>
    <span class="metric-chip">Página actual: {{ page }}</span>
  </div>
</section>

<div class="d-flex flex-wrap gap-2 justify-content-between align-items-center mb-3">
  <h2 class="h5 mb-0 text-primary">Productos</h2>
</div>

@if (alertMessage) {
  <div class="alert" [ngClass]="alertType === 'success' ? 'alert-success' : 'alert-danger'" role="alert">
    {{ alertMessage }}
  </div>
}

<div class="card pro-card mb-3">
  <div class="card-body">
    <div class="row g-2 align-items-end">
      <div class="col-md-4">
        <label class="form-label">Buscar</label>
        <input [(ngModel)]="search" type="text" class="form-control" placeholder="Nombre del producto" />
      </div>
      <div class="col-md-3">
        <label class="form-label">Categoría</label>
        <select [(ngModel)]="categoria" class="form-select">
          <option value="">Todas</option>
          <option value="calzado">Calzado</option>
          <option value="ropa">Ropa</option>
          <option value="accesorios">Accesorios</option>
          <option value="equipamiento">Equipamiento</option>
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label">Activo</label>
        <select [(ngModel)]="activo" class="form-select">
          <option value="">Todos</option>
          <option value="true">Sí</option>
          <option value="false">No</option>
        </select>
      </div>
      <div class="col-md-3 d-flex gap-2">
        <button class="btn btn-outline-primary w-100" (click)="applyFilters()">Filtrar</button>
        <button class="btn btn-outline-dark w-100" (click)="clearFilters()">Limpiar</button>
      </div>
    </div>
  </div>
</div>

@if (loading) {
  <div class="text-center py-4">
    <div class="spinner-border" role="status"></div>
  </div>
}

@if (!loading) {
  <div class="card pro-card">
    <div class="card-body">
      <div class="row g-3">
        @for (product of products; track product) {
          <div class="col-md-6 col-xl-4">
            <div class="card h-100 product-card">
              <button class="btn p-0 border-0 bg-transparent" (click)="openPreview(resolveImage(product), product.nombre)">
                <img
                  [src]="resolveImage(product)"
                  [alt]="product.nombre"
                  (error)="onImageError($event)"
                  class="card-img-top"
                  style="height: 90px; object-fit: contain; object-position: center; background: #f8f9fa; padding: 6px; image-rendering: pixelated"
                  />
                </button>
                <div class="card-body d-flex flex-column">
                  <div class="d-flex justify-content-between align-items-start gap-2 mb-2">
                    <h5 class="card-title mb-0 text-primary">{{ product.nombre }}</h5>
                    <span class="badge" [ngClass]="product.activo ? 'text-bg-success' : 'text-bg-secondary'">
                      {{ product.activo ? 'Activo' : 'Inactivo' }}
                    </span>
                  </div>
                  <div class="mb-3 d-flex flex-wrap gap-2">
                    <span class="badge text-bg-info text-capitalize">{{ product.categoria }}</span>
                    <span class="badge text-bg-light border">Stock: {{ product.stock }}</span>
                  </div>
                  <p class="card-text price-tag mb-3">{{ product.precio | currency : 'EUR' }}</p>
                  <div class="mt-auto d-flex gap-2">
                    <a class="btn btn-sm btn-outline-info w-100" [routerLink]="['/productos', product._id]">Ver</a>
                    <a class="btn btn-sm btn-outline-warning w-100" [routerLink]="['/productos/editar', product._id]">Editar</a>
                    <button class="btn btn-sm btn-outline-danger w-100" (click)="removeProduct(product._id)">Eliminar</button>
                  </div>
                </div>
              </div>
            </div>
          }
          @if (products.length === 0) {
            <div class="col-12">
              <div class="text-center py-4">No hay productos para mostrar.</div>
            </div>
          }
        </div>
      </div>
      <div class="card-footer bg-white border-0 d-flex justify-content-between align-items-center">
        <small class="text-secondary fw-semibold">Registros: {{ total }} | Páginas: {{ totalPages }} | Página actual: {{ page }}</small>
        <div class="btn-group">
          <button class="btn btn-sm btn-outline-secondary" (click)="prevPage()" [disabled]="page <= 1">Anterior</button>
          <button class="btn btn-sm btn-outline-secondary" (click)="nextPage()" [disabled]="page >= totalPages">Siguiente</button>
        </div>
      </div>
    </div>
  }

  @if (previewImage) {
    <div class="position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center" style="background: rgba(0,0,0,0.75); z-index: 2000" (click)="closePreview()">
      <div class="bg-white p-2 rounded" style="max-width: 90vw; max-height: 90vh" (click)="$event.stopPropagation()">
        <div class="d-flex justify-content-between align-items-center mb-2 px-2">
          <strong>{{ previewTitle }}</strong>
          <button class="btn btn-sm btn-outline-dark" (click)="closePreview()">Cerrar</button>
        </div>
        <img [src]="previewImage" [alt]="previewTitle" class="img-fluid rounded" style="max-height: 80vh; object-fit: contain" />
      </div>
    </div>
  }
